var m=class{constructor(t){this.dirHandle=t}static fileExtensionMatch(t){return t=t.startsWith(".")?t:`.${t}`,e=>e.name.endsWith(t)}async getFilesAsync(t){let e=s=>(typeof t=="function"?t(s):!0)&&s.kind=="file";return await this.getEntriesAsync(e)}async getEntriesAsync(t){let e=r=>typeof t=="function"?t(r):!0,s=[];for await(let r of this.dirHandle.values())e(r)&&s.push(r);return s}async getFileAsync(t){return await this.getFirstFileOrDefaultAsync(e=>e.name===t)}async getFirstFileOrDefaultAsync(t){let e=s=>(typeof t=="function"?t(s):!0)&&s.kind=="file";return await this.getFirstEntryOrDefaultAsync(s=>e(s))}async getFirstEntryOrDefaultAsync(t){let e=s=>typeof t=="function"?t(s):!0;for await(let s of this.dirHandle.values())if(e(s))return s;return null}async verifyReadPermissionAsync(){return await this.verifyPermissionAsync()}async verifyPermissionAsync(t="read"){let e={};return t&&(e.mode=t),await this.dirHandle.queryPermission(e)==="granted"||await this.dirHandle.requestPermission(e)==="granted"}};import{get as v,set as F}from"https://unpkg.com/idb-keyval@5.0.2/dist/esm/index.js";var l=class n{constructor(t){if(typeof t!="string"||t.length!==36)throw new TypeError("The given value is not a Guid");this.value=t}static create(){return new n(crypto.randomUUID())}static parse(t){return new n(t.value)}equalsTo(t){return t instanceof n&&this.value===t.value}toString(){return this.value}};var a=class n{constructor(t,e,s){if(typeof t!="number")throw new Error("playlistItemIndex should be a number");if(typeof e!="number")throw new Error("time should be a number");if(typeof s!="number")throw new Error("playbackRate should be a number");this.playlistItemIndex=t,this.time=e,this.playbackRate=s}static parse(t){return t?new n(t.playlistItemIndex,t.time,t.playbackRate):void 0}applyToPlayer(t){t.playlist.currentItem(this.playlistItemIndex),t.currentTime(this.time)}static createFromPlayer(t){let e=t.playlist.currentIndex(),s=t.currentTime(),r=t.playbackRate();return new n(e,s,r)}};var c=class n{constructor(t,e,s){if(!(t instanceof l))throw new Error("The given instance is not an instance of Guid");if(!(e instanceof FileSystemHandle))throw new Error("The given instance is not an instance of FileSystemHandle");if(s&&!(s instanceof a))throw new Error("The given instance is not an instance of PlaybackPosition");this.id=t,this.fsHandle=e,this.lastPosition=s}static create(t){return new n(l.create(),t)}static parse(t){return new n(l.parse(t.id),t.fsHandle,a.parse(t.lastPosition))}get lastPlaylistItemIndex(){return this.lastPosition.playlistItemIndex}async equalsToAsync(t){if(!(t instanceof n))throw new Error("The given instance is not an instance of HistoryItem");return await this.fsHandle.isSameEntry(t.fsHandle)}};var y=class{static async mapAsync(t,e){let s=[];for(let r=0;r<t.length;++r){let u=t[r];s.push(await e(u))}return s}static async someAsync(t,e){if(!(t instanceof Array))throw new Error("The array parameter should be an instance of an array");for(let s=0;s<t.length;++s){let r=t[s];if(await e(r,s,t))return!0}return!1}};var i=class n{static indexDbKey="playlistApp-history";constructor(t){this.items=t}static async loadAsync(){let t=await v(n.indexDbKey),e=t?t.items.map(s=>c.parse(s)):[];return new n(e)}async addItemAsync(t){await this.containsItemAsync(t)||(this.items.push(t),await this.saveChangesAsync())}async containsItemAsync(t){return await y.someAsync(this.items,async e=>await e.equalsToAsync(t))}async saveChangesAsync(){await F(n.indexDbKey,this)}getLastItemOrDefault(){return this.items.length>0?this.items[this.items.length-1]:null}async getItemByFsHandleAsync(t){for(let e=0;e<this.items.length;++e){let s=this.items[e];if(await s.fsHandle.isSameEntry(t))return s}throw new Error("Unable to find the history with item with the given handle")}};var o=class{constructor(t,e){this.Filename=t,this.Title=e}};var f=class{async parseStreamAsync(t){let e=await new Response(t).text();var s=new m3u8Parser.Parser;s.push(e),s.end();var r=s.manifest;return r.segments.map(u=>new o(u.uri,u.title))}async parseStringAsync(t){return t.split(`\r
`).filter(e=>e.trim().length>0).map(e=>new o(e,e))}async parseString2Async(t){return t.split(`\r
`).filter(e=>e.trim().length>0).map(e=>new o(e,e))}};var h=class{constructor(t,e){this.player=t,this.playlistFsHandle=e}start(){this.player.on("playlistitem",async()=>{await this.savePlaybackPositionAsync()})}startMonitoringPlaybackPosition(){this.intervalHandle=setInterval(()=>{this.savePlaybackPositionAsync()},1e3)}stop(){}async savePlaybackPositionAsync(){let t=await i.loadAsync(),e=await t.getItemByFsHandleAsync(this.playlistFsHandle);e.lastPosition=a.createFromPlayer(this.player),await t.saveChangesAsync()}};function p(n){let t=n.el().querySelector("video"),e=t.playbackRate;k(t,s=>{console.log("hookPlaybackRate "+s)})}var k=(n,t)=>{console.log(">>>>>>> hookPlaybackRate init");let e=Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype,"playbackRate");Object.defineProperty(n,"playbackRate",{get(){return e.get.call(this)},set(s){return console.trace(),t(s),e.set.call(this,s)},configurable:!0,enumerable:!0})};document.getElementById("selectFolderBtn").addEventListener("click",x);H();async function H(){let t=(await i.loadAsync()).getLastItemOrDefault();if(!t)return;let e=await g(t.fsHandle,t.lastPosition)}async function x(){let n=await window.showDirectoryPicker();await g(n)}async function g(n,t){if(!(n instanceof FileSystemHandle))throw new Error("A directory file system handle is required");let e=await T(n),s=E(e,t);return new h(s,n).start(),s}function E(n,t){let e=videojs("videoPlayer",{autoplay:!0,plugins:{hotkeys:{volumeStep:.1,seekStep:5,enableModifiersForNumbers:!1}}});return new p(e),e.playlist(n),e.playlistUi(),e.playlist.autoadvance(0),t&&t.applyToPlayer(e),e}async function T(n){let t=new m(n),e=c.create(n);if(await(await i.loadAsync()).addItemAsync(e),!await t.verifyReadPermissionAsync()){alert("You must give the permission in order to save you your local history");return}let r=await t.getFirstFileOrDefaultAsync(m.fileExtensionMatch(".m3u"));if(!r)throw new Error("Playlist file not found");let A=(await r.getFile()).stream(),P=await new f().parseStreamAsync(A),b=async d=>{let w=await(await t.getFileAsync(d.Filename)).getFile(),I=URL.createObjectURL(w);return{name:d.Filename,sources:[{type:w.type,src:I}]}};return await y.mapAsync(P,b)}
